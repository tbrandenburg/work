# Investigation: CI Tests Failing - Missing Directory for ID Counter

**Issue**: PR #23 (https://github.com/tbrandenburg/work/pull/23)
**Type**: BUG
**Investigated**: 2026-01-22T20:14:27.490+01:00

### Assessment

| Metric     | Value  | Reasoning                                                                                    |
|------------|--------|----------------------------------------------------------------------------------------------|
| Severity   | HIGH   | CI is completely broken across all Node.js versions, blocking PR merge and development flow |
| Complexity | LOW    | Simple directory creation fix, isolated to one function in id-generator.ts                   |
| Confidence | HIGH   | Clear error pattern with consistent ENOENT failures, obvious missing directory creation      |

---

## Problem Statement

CI tests are failing across all Node.js versions (18.x, 20.x, 22.x) with "ENOENT: no such file or directory, open id-counter.json" errors. The `generateId` function attempts to write to a file without ensuring the parent directory exists first, causing failures in clean CI environments.

---

## Analysis

### Root Cause / Change Rationale

The `generateId` function in the local filesystem adapter writes an ID counter file without creating the necessary directory structure first. This works locally where the `.work` directory might exist from previous runs, but fails in CI's clean environment.

### Evidence Chain

WHY: Tests fail with "ENOENT: no such file or directory, open id-counter.json"
↓ BECAUSE: generateId tries to write to a directory that doesn't exist
Evidence: `src/adapters/local-fs/id-generator.ts:42` - `await fs.writeFile(counterPath, JSON.stringify(counters, null, 2));`

↓ BECAUSE: generateId doesn't ensure parent directory exists before writing
Evidence: `src/adapters/local-fs/id-generator.ts:26-42` - No directory creation before `fs.writeFile`

↓ BECAUSE: generateId is called before saveWorkItem, and only saveWorkItem calls ensureWorkDir
Evidence: `src/adapters/local-fs/storage.ts:25` - `ensureWorkDir` only called in `saveWorkItem`

↓ ROOT CAUSE: Missing directory creation in generateId function
Evidence: `src/adapters/local-fs/id-generator.ts:26` - Function starts file operations without directory setup

### Affected Files

| File            | Lines | Action | Description    |
|-----------------|-------|--------|----------------|
| `src/adapters/local-fs/id-generator.ts` | 26-42 | UPDATE | Add directory creation before writing counter file |

### Integration Points

- `src/adapters/local-fs/index.ts:28` calls generateId in createWorkItem
- `src/adapters/local-fs/storage.ts:13` has ensureWorkDir function that can be reused
- All CLI commands that create work items depend on this functionality

### Git History

- **Introduced**: 1785925 - 2026-01-22 - "feat: Complete Core Engine & Local-fs MVP Implementation (#13)"
- **Last modified**: 1785925 - Same commit
- **Implication**: New file from recent MVP implementation, bug introduced with initial implementation

---

## Implementation Plan

### Step 1: Import ensureWorkDir function

**File**: `src/adapters/local-fs/id-generator.ts`
**Lines**: 1-10
**Action**: UPDATE

**Current code:**

```typescript
// Line 1-10
/**
 * Work item ID generation with sequential numbering
 */

import { promises as fs } from 'fs';
import path from 'path';
import { WorkItemKind } from '../../types/index.js';

const ID_COUNTER_FILE = 'id-counter.json';
```

**Required change:**

```typescript
/**
 * Work item ID generation with sequential numbering
 */

import { promises as fs } from 'fs';
import path from 'path';
import { WorkItemKind } from '../../types/index.js';
import { ensureWorkDir } from './storage.js';

const ID_COUNTER_FILE = 'id-counter.json';
```

**Why**: Need to import the existing directory creation utility

---

### Step 2: Add directory creation before file operations

**File**: `src/adapters/local-fs/id-generator.ts`
**Lines**: 26-42
**Action**: UPDATE

**Current code:**

```typescript
// Line 26-42
export async function generateId(kind: WorkItemKind, workDir: string): Promise<string> {
  const counterPath = path.join(workDir, ID_COUNTER_FILE);
  
  let counters: IdCounters;
  
  try {
    const data = await fs.readFile(counterPath, 'utf-8');
    counters = { ...DEFAULT_COUNTERS, ...(JSON.parse(data) as Partial<IdCounters>) };
  } catch (error) {
    // File doesn't exist or is invalid, start with defaults
    if ((error as NodeJS.ErrnoException).code === 'ENOENT') {
      counters = { ...DEFAULT_COUNTERS };
    } else {
      throw error;
    }
  }
  
  // Increment counter for this kind
  counters[kind] += 1;
  
  // Save updated counters
  await fs.writeFile(counterPath, JSON.stringify(counters, null, 2));
```

**Required change:**

```typescript
export async function generateId(kind: WorkItemKind, workDir: string): Promise<string> {
  // Ensure the work directory exists before any file operations
  await ensureWorkDir(workDir);
  
  const counterPath = path.join(workDir, ID_COUNTER_FILE);
  
  let counters: IdCounters;
  
  try {
    const data = await fs.readFile(counterPath, 'utf-8');
    counters = { ...DEFAULT_COUNTERS, ...(JSON.parse(data) as Partial<IdCounters>) };
  } catch (error) {
    // File doesn't exist or is invalid, start with defaults
    if ((error as NodeJS.ErrnoException).code === 'ENOENT') {
      counters = { ...DEFAULT_COUNTERS };
    } else {
      throw error;
    }
  }
  
  // Increment counter for this kind
  counters[kind] += 1;
  
  // Save updated counters
  await fs.writeFile(counterPath, JSON.stringify(counters, null, 2));
```

**Why**: Ensures directory structure exists before attempting file operations

---

## Patterns to Follow

**From codebase - mirror these exactly:**

```typescript
// SOURCE: src/adapters/local-fs/storage.ts:25-30
// Pattern for ensuring directory exists before file operations
export async function saveWorkItem(workItem: WorkItem, workDir: string): Promise<void> {
  await ensureWorkDir(workDir);
  
  const fileName = `${workItem.id}.md`;
  const filePath = path.join(workDir, WORK_ITEMS_DIR, fileName);
```

```typescript
// SOURCE: src/adapters/local-fs/storage.ts:13-22
// Pattern for directory creation with error handling
export async function ensureWorkDir(workDir: string): Promise<void> {
  try {
    await fs.mkdir(workDir, { recursive: true });
    await fs.mkdir(path.join(workDir, WORK_ITEMS_DIR), { recursive: true });
  } catch (error) {
    // Directory might already exist, ignore EEXIST errors
    if ((error as NodeJS.ErrnoException).code !== 'EEXIST') {
      throw error;
    }
  }
}
```

---

## Edge Cases & Risks

| Risk/Edge Case | Mitigation      |
|----------------|-----------------|
| Directory creation fails due to permissions | ensureWorkDir already handles this with proper error handling |
| Race condition with multiple processes | fs.mkdir with recursive: true is atomic and handles concurrent calls |
| Performance impact from repeated directory checks | ensureWorkDir is idempotent and mkdir with recursive is fast for existing dirs |

---

## Validation

### Automated Checks

```bash
npm run type-check   # Verify TypeScript compilation
npm test tests/unit/cli/json-output.test.ts  # Test the failing test file
npm run lint         # Verify code style
```

### Manual Verification

1. Run the failing test locally to confirm it passes after fix
2. Verify CI passes on all Node.js versions (18.x, 20.x, 22.x)
3. Test create command works: `./bin/run.js create "Test task" --format json`

---

## Scope Boundaries

**IN SCOPE:**

- Fix directory creation in generateId function
- Import existing ensureWorkDir utility
- Maintain existing error handling patterns

**OUT OF SCOPE (do not touch):**

- Changing the overall directory structure or file naming
- Modifying the ensureWorkDir function itself
- Altering test files or CI configuration
- Performance optimizations beyond the immediate fix

---

## Metadata

- **Investigated by**: Claude
- **Timestamp**: 2026-01-22T20:14:27.490+01:00
- **Artifact**: `.claude/PRPs/issues/pr-23.md`
