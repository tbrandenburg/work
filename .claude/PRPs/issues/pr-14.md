# Investigation: CI Tests Failing - Commands Not Found

**Issue**: PR #14 (https://github.com/tbrandenburg/work/pull/14)
**Type**: BUG
**Investigated**: 2026-01-21T14:37:51.692+01:00

### Assessment

| Metric     | Value  | Reasoning                                                                                    |
| ---------- | ------ | -------------------------------------------------------------------------------------------- |
| Severity   | HIGH   | Blocking PR merge, all CI jobs failing across Node.js versions, no workaround available     |
| Complexity | LOW    | Single file change to fix CI workflow step order, isolated change with low risk             |
| Confidence | HIGH   | Clear root cause identified with strong evidence from CI logs and oclif configuration       |

---

## Problem Statement

CI tests are failing across all Node.js versions (18.x, 20.x, 22.x) with "Error: command create:Test Task not found". The CLI commands work locally but are not recognized in the CI environment, preventing PR merge.

---

## Analysis

### Root Cause / Change Rationale

The CI workflow runs tests before building the TypeScript files, but oclif requires compiled JavaScript files in `dist/cli/commands` to discover and load commands.

### Evidence Chain

**WHY**: Tests fail with "command create:Test Task not found"
↓ **BECAUSE**: oclif cannot find commands in `./dist/cli/commands`
Evidence: `package.json:67` - `"target": "./dist/cli/commands"`

↓ **BECAUSE**: TypeScript files not compiled to dist/ when tests run
Evidence: `.github/workflows/ci.yml:26-30` - test runs before build

↓ **ROOT CAUSE**: CI workflow step order is incorrect
Evidence: Tests need built commands but build happens after tests

### Affected Files

| File                        | Lines | Action | Description                    |
| --------------------------- | ----- | ------ | ------------------------------ |
| `.github/workflows/ci.yml`  | 26-30 | UPDATE | Move build step before tests   |

### Integration Points

- oclif framework loads commands from `dist/cli/commands` (package.json:67)
- E2E tests execute CLI via `bin/run.js` which uses oclif command discovery
- CI workflow must build before testing for command discovery to work

### Git History

- **Current CI**: Tests run before build (lines 26-30)
- **Local Success**: dist/ directory exists from previous builds
- **CI Failure**: Fresh environment has no dist/ directory when tests run

---

## Implementation Plan

### Step 1: Fix CI workflow step order

**File**: `.github/workflows/ci.yml`
**Lines**: 26-30
**Action**: UPDATE

**Current code:**

```yaml
# Lines 26-30
- name: Run tests
  run: npm test -- --coverage
  
- name: Build project
  run: npm run build
```

**Required change:**

```yaml
# Move build before tests
- name: Build project
  run: npm run build
  
- name: Run tests
  run: npm test -- --coverage
```

**Why**: oclif needs compiled JavaScript files in dist/cli/commands to discover commands during test execution.

---

## Patterns to Follow

**From codebase - mirror these exactly:**

```yaml
# SOURCE: .github/workflows/ci.yml:18-24
# Pattern for CI step structure
- name: Install dependencies
  run: npm ci
  
- name: Run type check
  run: npm run type-check
  
- name: Run linting
  run: npm run lint
```

---

## Edge Cases & Risks

| Risk/Edge Case              | Mitigation                                    |
| --------------------------- | --------------------------------------------- |
| Build failure breaks tests | Type check and lint run first to catch issues |
| Increased CI time          | Minimal impact - build is fast (~10s)         |

---

## Validation

### Automated Checks

```bash
# CI workflow will validate the fix
npm ci
npm run type-check
npm run lint
npm run build    # Now runs before tests
npm test -- --coverage
```

### Manual Verification

1. Check that CI jobs pass after workflow change
2. Verify all Node.js versions (18.x, 20.x, 22.x) succeed
3. Confirm commands are recognized in test execution

---

## Scope Boundaries

**IN SCOPE:**
- Fix CI workflow step order
- Ensure tests run after build

**OUT OF SCOPE (do not touch):**
- Test content or structure
- oclif configuration
- Command implementations
- Package.json build scripts

---

## Metadata

- **Investigated by**: Claude
- **Timestamp**: 2026-01-21T14:37:51.692+01:00
- **Artifact**: `.claude/PRPs/issues/pr-14.md`
